# moku-instrument-forge-vhdl

Shared VHDL utilities for Moku custom instrument development with CocoTB progressive testing.

## Quick Reference

**What:** Reusable VHDL components with token-efficient CocoTB tests
**Use:** Git submodule in forge-based projects
**Test:** CocoTB + GHDL filter (P1 tests <20 lines, 98% noise reduction)

## Structure

```
vhdl/
â”œâ”€â”€ packages/       # Voltage utilities, serialization, common types
â”‚   â”œâ”€â”€ forge_voltage_*_pkg          # Direct voltage utilities (3v3, 5v0, 5v_bipolar)
â”‚   â”œâ”€â”€ forge_serialization_*_pkg    # Register serialization (types, voltage, time)
â”‚   â”œâ”€â”€ forge_common_pkg             # FORGE_READY control scheme
â”‚   â””â”€â”€ forge_lut_pkg                # Look-up table utilities
â”œâ”€â”€ utilities/      # forge_util_clk_divider (+ tests), threshold trigger
â”œâ”€â”€ debugging/      # fsm_observer (real-time FSM monitoring)
â””â”€â”€ loader/         # forge_bram_loader (BRAM initialization)

scripts/            # ghdl_output_filter.py (THE secret weapon)
tests/              # CocoTB progressive testing infrastructure
docs/               # Testing standards, guides, patterns
```

## Key Components (With CocoTB Tests)

**forge_util_clk_divider** - Programmable clock divider
- P1 tests: 3 (reset, divide-by-2, enable)
- Output: ~20 lines, ~50 tokens

**forge_lut_pkg** - Look-up table utilities
- P1 tests: 4 (constants, conversions, index, boundary)
- Output: ~15 lines, ~70 tokens

**forge_voltage_3v3_pkg** - 0-3.3V voltage domain (TTL/digital logic)
- P1 tests: 4 (to_digital, from_digital, is_valid, clamp)
- Output: ~9 lines

**forge_voltage_5v0_pkg** - 0-5.0V voltage domain (unipolar supply)
- P1 tests: 4 (same as above)
- Output: ~9 lines

**forge_voltage_5v_bipolar_pkg** - Â±5.0V voltage domain (Moku DAC/ADC)
- P1 tests: 4 (same as above)
- Output: ~9 lines

**Design:** Function-based type safety, Verilog compatible, explicit domain selection
**Details:** .migration/VOLTAGE_TYPE_SYSTEM_DESIGN.md, .migration/voltage_types_reference.py

**forge_serialization_types_pkg** - Core serialization type utilities (NEW!)
- Boolean â†” std_logic conversions (`bool_to_sl`, `sl_to_bool`)
- Register bit type (`std_logic_reg_from_raw`, `std_logic_reg_to_raw`) - identity functions
- Use with: forge_serialization_voltage_pkg, forge_serialization_time_pkg

**forge_serialization_voltage_pkg** - Voltage register serialization (NEW!)
- Converts voltage values â†” register bits
- Available ranges: Â±0.5V, Â±5V, Â±20V, Â±25V (16-bit/8-bit, signed/unsigned variants)
- New in v1.1: Â±5V types (`voltage_input_5v_bipolar_s16`, `voltage_output_5v_bipolar_s16`)
- Use for: Control register communication with Moku DAC/ADC

**forge_serialization_time_pkg** - Time register serialization (NEW!)
- Converts time durations â†” clock cycles
- Clock-frequency aware functions
- Use for: Timing control via registers

**forge_common_pkg** - FORGE_READY control scheme (NEW! from BPD)
- CR0[31:29] safe initialization handshaking
- BRAM loader protocol constants
- combine_forge_ready() function
- Production-proven architecture pattern

**fsm_observer** - Export FSM state to Moku registers (no tests yet)
**forge_bram_loader** - BRAM initialization (no tests yet)

## AI Agent Toolkit (NEW!)

**forge-vhdl includes specialized agents for autonomous VHDL development:**

### Development Workflow

**Requirements Gathering** â†’ **0. New Component Planner** â†’ **1. Component Generator** â†’ **2. Test Designer** â†’ **3. Test Runner**

**Slash Command: /gather-requirements** (`.claude/commands/gather-requirements.md`) â­ NEW!
- **Purpose:** Interactive requirements gathering session
- **Output:** Complete component specification in `workflow/specs/pending/`
- **Process:** 7-phase Q&A (identification, functionality, interface, behavior, testing, design, generation)
- **Features:** Standards validation, guided questions, educational
- **Usage:** Start here for new components! Creates detailed spec before implementation.

**Step 0: forge-new-component** (`.claude/agents/forge-new-component/agent.md`)
- **Purpose:** File structure scaffolding from specifications
- **Modes:** Placeholder generation from specs
- **Outputs:** Markdown placeholder files (.vhd.md, .py.md) with specifications
- **Next:** Hand off to Component Generator + Test Designer (parallel)
- **Usage:** Converts specs into placeholder files for agent workflow.

**Step 1: forge-vhdl-component-generator** (`.claude/forge-vhdl-component-generator.md`)
- **Purpose:** VHDL-2008 code generation with GHDL simulation awareness
- **Modes:** Pure VHDL, FORGE-aware, component usage, CocoTB tests
- **Inputs:** Requirements (from forge-new-component placeholder or direct spec)
- **Outputs:** VHDL component entity/architecture
- **Next:** Hand off to Test Designer

**Step 2: cocotb-progressive-test-designer** (`.claude/agents/cocotb-progressive-test-designer/`)
- **Purpose:** Design P1/P2/P3 test architectures
- **Inputs:** VHDL component from Component Generator + placeholders from forge-new-component
- **Outputs:** Test strategy, expected values, test wrappers, constants file design
- **Next:** Hand off to Test Runner

**Step 3: cocotb-progressive-test-runner** (`.claude/agents/cocotb-progressive-test-runner/`)
- **Purpose:** Implement and execute CocoTB tests
- **Inputs:** Test architecture from Test Designer + placeholders from forge-new-component
- **Outputs:** Working test suite, execution results
- **Next:** Complete or iterate with Test Designer

**Each agent is aware of its role in the workflow and references neighbors.**

### Quick Start Pattern

**For brand new components (recommended):**
1. `/gather-requirements` - Interactive Q&A â†’ Creates `workflow/specs/pending/component.md`
2. **Automated workflow** - Run 4-agent workflow on spec â†’ Generates VHDL + tests
3. **Review artifacts** - Check `workflow/artifacts/vhdl/` and `workflow/artifacts/tests/`
4. **Integrate** - Move to main codebase when satisfied

**Using example specs (fast):**
- 4 ready-to-use specs in `workflow/specs/pending/`:
  - `edge_detector.md` - Edge detection utility
  - `synchronizer.md` - CDC metastability mitigation
  - `debouncer.md` - Button debouncing
  - `pulse_stretcher.md` - Pulse width extension
- Run: "Read workflow/specs/pending/edge_detector.md and execute the complete 4-agent workflow"

**For direct implementation (requirements crystal clear):**
1. **forge-vhdl-component-generator** - Direct spec â†’ Creates .vhd
2. **cocotb-progressive-test-designer** - Analyzes .vhl â†’ Designs tests
3. **cocotb-progressive-test-runner** - Implements tests

## Testing (NEW!)

```bash
# Run P1 tests (LLM-optimized, <20 lines)
uv run python tests/run.py forge_util_clk_divider

# Run P2 tests (full validation)
TEST_LEVEL=P2_INTERMEDIATE uv run python tests/run.py forge_util_clk_divider

# List all tests
uv run python tests/run.py --list
```

## Integration Pattern

Used as submodule in `moku-instrument-forge-mono-repo`:

```bash
git submodule add https://github.com/sealablab/moku-instrument-forge-vhdl.git libs/forge-vhdl
```

VHDL files compiled with GHDL via CocoTB test infrastructure.

## Cloud Setup (For GitHub Codespaces / Claude Code Web)

**ðŸš€ Automated setup with GHDL installation:**

```bash
uv run python scripts/cloud_setup_with_ghdl.py
```

This script will:
- Auto-install GHDL + LLVM 18 (Ubuntu/Debian)
- Create LLVM library symlink (critical!)
- Set up Python packages in editable mode
- Validate environment with tests
- Report readiness status

**See:** `docs/CLOUD_SETUP_PROMPT.md` for detailed cloud deployment guide.

## Local Development

```bash
uv sync                          # Install dependencies
uv run python tests/run.py --all # Run all tests (P1)
```

**Note:** Local development requires GHDL to be pre-installed:
- Ubuntu/Debian: `sudo apt-get install ghdl`
- macOS: `brew install ghdl`

## Testing Quick Start

```bash
# Run P1 tests (default, LLM-optimized, <20 lines output)
uv run python tests/run.py forge_util_clk_divider

# Run P2 tests (comprehensive validation)
TEST_LEVEL=P2_INTERMEDIATE uv run python tests/run.py forge_util_clk_divider

# Run with more verbosity
COCOTB_VERBOSITY=NORMAL uv run python tests/run.py forge_util_clk_divider

# List all available tests
uv run python tests/run.py --list

# Run all tests (P1)
uv run python tests/run.py --all
```

## Documentation Hierarchy

**Three-tier documentation system optimized for token efficiency:**

**Tier 1 (Quick Ref):** This file (llms.txt) - ~800 tokens
- Component catalog
- Basic usage examples
- Pointers to Tier 2

**Tier 2 (Authoritative):** CLAUDE.md - ~3.5k tokens
- Complete testing standards
- CocoTB progressive testing guide
- Critical interface rules (real/boolean type constraints)
- VHDL coding standards summary
- Component integration patterns
- Quick reference appendix

**Tier 3 (Specialized):** Load only when needed
- `docs/VHDL_CODING_STANDARDS.md` - Complete style guide (rarely loaded)
- `docs/COCOTB_TROUBLESHOOTING.md` - Problemâ†’Solution debugging
- `scripts/GHDL_FILTER.md` - Filter implementation details

**Workflow Documentation:**
- `workflow/specs/README.md` - Specification writing guide
- `workflow/README.md` - Complete workflow guide
- `.claude/commands/README.md` - Slash commands reference
- `REQUIREMENTS_WORKFLOW_SUMMARY.md` - Requirements gathering system overview

**Navigation pattern:**
- Quick question? â†’ Read llms.txt (this file)
- Design/testing question? â†’ Read CLAUDE.md
- Workflow question? â†’ Read workflow/README.md
- Specific error/deep dive? â†’ Read Tier 3 docs

---

**Version:** 2.0.0 (aligned with parent monorepo 3-tier pattern)
**License:** MIT
**Standalone:** Yes (works outside monorepo)
